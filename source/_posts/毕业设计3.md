---
title: æ¯•ä¸šè®¾è®¡3
categories:
  - ä¸ªäººæå‡
  - æ¯•ä¸šè®¾è®¡
thumbnailImage: 'http://cdn.ekko306.top/cover/Red%20Pill%20Blues%20%28Deluxe%29.jpg'
date: 2021-11-30 11:05:15
tags:
coverImage:
coverCaption:
gallery:
---

æ¯•ä¸šè®¾è®¡ï¼ŒASP.NETçš„MVCæ¶æ„
<!-- more -->
<!-- toc -->
# MVC
ğŸ¦„ï¼š[githubåœ°å€:MvcMovie](https://github.com/Ekko306/SignalR_Practice/tree/main/MvcMovie)

ğŸ½ï¼š[æ–‡æ¡£åœ°å€](https://docs.microsoft.com/zh-cn/aspnet/core/tutorials/first-mvc-app/start-mvc?view=aspnetcore-3.1&tabs=visual-studio)

æœ‰äº›æ¦‚å¿µRazorä¸€è‡´ï¼Œä½†æ˜¯MVCæ¨¡å¼è¿˜å¾ˆå¤šä¸åŒçš„ï¼Œå¾ˆå¤šè¦æ‰‹åŠ¨æ“ä½œ
## å…¥é—¨
è¿˜æ˜¯åˆ›å»ºé¡¹ç›®ï¼Œä½†é€‰æ‹©Web Application (Model-View-Controller)
## æ·»åŠ æ§åˆ¶å™¨
ä»‹ç»æ§åˆ¶å™¨æ¦‚å¿µå†ç»™ä¸€ä¸ªHelloWorldä¾‹å­
### MVCæ¦‚å¿µ
æ¨¡å‹-è§†å›¾-æ§åˆ¶å™¨(MVC)ä½“ç³»ç»“æ„æ¨¡å¼å°†åº”ç”¨åˆ†æˆä¸‰ä¸ªä¸»è¦ç»„ä»¶ï¼Œæœ‰åŠ©äºåˆ›å»ºæ¯”å•ç‰‡åº”ç”¨æ›´æ˜“æµ‹è¯•å’Œæ›´æ–°çš„åº”ç”¨

1. æ¨¡å‹(M)ï¼šè¡¨ç¤ºåº”ç”¨æ•°æ®çš„ç±»ã€‚å¯¹æ•°æ®æ–½åŠ ä¸šåŠ¡è§„åˆ™ï¼Œæ¨¡å‹çš„çŠ¶æ€ä¸€èˆ¬å’Œæ•°æ®åº“ä¸€è‡´ï¼ŒåŒæ­¥æ›´æ–°ï¼Œ
2. è§†å›¾(V)ï¼šæ˜¾ç¤ºåº”ç”¨ç•Œé¢UIçš„ç»„ä»¶ï¼ˆé€šå¸¸æ¨¡å‹æ•°æ®ï¼‰
3. æ§åˆ¶å™¨(C)ï¼šæ‰§è¡Œæ“ä½œçš„ç±»ï¼ˆå¤„ç†æµè§ˆå™¨è¯·æ±‚ï¼Œæ£€ç´¢æ¨¡å‹æ•°æ®ï¼Œè°ƒç”¨è¿”å›å“åº”çš„è§†å›¾æ¨¡æ¿(æ ¹æ®è·¯ç”±)ï¼‰

MVCåˆä½œçš„ä¾‹å­ï¼ˆè·¯ç”±æ•°æ®ï¼‰ï¼š
1. æ§åˆ¶å™¨å¤„ç† URL æ®µå’ŒæŸ¥è¯¢å­—ç¬¦ä¸²å€¼ï¼Œå¹¶å°†è¿™äº›å€¼ä¼ é€’ç»™æ¨¡å‹ã€‚ è¯¥æ¨¡å‹å¯ä½¿ç”¨è¿™äº›å€¼æŸ¥è¯¢æ•°æ®åº“ï¼Œç„¶ååœ¨è§†å›¾å±•ç¤º
2. ä¾‹å¦‚ï¼š `https://localhost:5001/Movies/Edit/5`ï¼šæ˜¯ä½¿ç”¨ `Movies` æ§åˆ¶å™¨å’Œ `Edit` æ“ä½œç¼–è¾‘ ID=5 çš„ç”µå½±çš„è¯·æ±‚ï¼Œæœ¬æ•™ç¨‹ç¨åå°†å¯¹æ­¤è¿›è¡Œè¯¦ç»†ä»‹ç»ã€‚

è¿™ç§æ¨¡å¼æœ‰åŠ©äºå®ç°å…³æ³¨ç‚¹åˆ†ç¦»ï¼š
1. UIé€»è¾‘ä½äºè§†å›¾ä¸­
2. è¾“å…¥é€»è¾‘ä½äºæ§åˆ¶å™¨ä¸­
3. ä¸šåŠ¡é€»è¾‘ä½äºæ¨¡å‹ä¸­

æœ‰åŠ©äºæ§åˆ¶æ„å»ºåº”ç”¨æ—¶çš„å¤æ‚ç¨‹åº¦ï¼Œä¸€æ¬¡å¤„ç†ä¸€ä¸ªç‰¹æ€§ï¼Œå®ç°éš”ç¦»

### æ·»åŠ æ§åˆ¶å™¨(HelloWorld)C
1. åœ¨Controllersæ–‡ä»¶å¤¹ï¼Œæ·»åŠ MVC Controller Class
2. æ·»åŠ ä¸‹é¢å†…å®¹
```cs
using Microsoft.AspNetCore.Mvc;
using System.Text.Encodings.Web;

namespace MvcMovie.Controllers
{
    public class HelloWorldController : Controller
    {
        // 
        // GET: /HelloWorld/

        public string Index()
        {
            return "This is my default action...";
        }

        // 
        // GET: /HelloWorld/Welcome/ 

        public string Welcome()
        {
            return "This is the Welcome action method...";
        }
    }
}
```

æ¯ä¸€ä¸ªpublicæ–¹æ³•éƒ½å¯ä»¥ä½œä¸ºHTTPç»ˆç»“ç‚¹

HTTPç»ˆç»“ç‚¹å®šä¹‰ï¼š
1. æ˜¯Webåº”ç”¨ç¨‹åºä¸­å¯å®šå‘çš„URLï¼Œå¦‚`https://localhost:5001/HelloWorld`
2. è§£é‡Šï¼š
	1. æ‰€ç”¨åè®®ï¼šHTTPS
	2. WebæœåŠ¡å™¨æ‰€åœ¨çš„ç½‘ç»œä½ç½®ï¼ŒåŒ…æ‹¬TCPç«¯å£ï¼šlocalhost:5001
	3. ç›®æ ‡URIï¼šHelloWorld

### URLè·¯ç”±é€»è¾‘
MVCé»˜è®¤çš„URLè·¯ç”±é€»è¾‘ï¼š
/[Controller]/[ActionName]/[Parameters]

åœ¨Startup.csæ–‡ä»¶`Configure`ä¸­è®¾ç½®è·¯ç”±æ ¼å¼
```cs
app.UseEndpoints(endpoints =>
{
    endpoints.MapControllerRoute(
        name: "default",
        pattern: "{controller=Home}/{action=Index}/{id?}");
});
```

1. "="æŒ‡å®šäº†é»˜è®¤çš„æ§åˆ¶å™¨Homeå’Œé»˜è®¤æ–¹æ³•Index
2. idæ˜¯**è·¯ç”±æ•°æ®**ï¼Œä¹Ÿå¯ä»¥æ·»åŠ **ä¸€äº›å‚æ•°**

ä¸‹é¢ç»™ä¸¤ä¸ªä¾‹å­ï¼Œå…¶å®å¥½ç†è§£ï¼Œä½†æ˜¯å¤ªè¾£é¸¡æ–‡æ¡£è¯´æ¥è¯´å»
#### ç¬¬ä¸€ç§è·¯ç”±
http://localhost:5001/HelloWorld/Welcome?name=Rick&numtimes=4

```cs
// GET: /HelloWorld/Welcome/ 
// Requires using System.Text.Encodings.Web;
public string Welcome(string name, int numTimes = 1)
{
    return HtmlEncoder.Default.Encode($"Hello {name}, NumTimes is: {numTimes}");
}
```



#### ç¬¬äºŒç§è·¯ç”±
https://localhost:5001/HelloWorld/Welcome/3?name=Rick

```
public string Welcome(string name, int ID = 1)
{
    return HtmlEncoder.Default.Encode($"Hello {name}, ID: {ID}");
}
```

```cs
app.UseEndpoints(endpoints =>
{
    endpoints.MapControllerRoute(
        name: "default",
        pattern: "{controller=Home}/{action=Index}/{id?}");
});
```


## æ·»åŠ è§†å›¾V
https://docs.microsoft.com/zh-cn/aspnet/core/tutorials/first-mvc-app/adding-view?view=aspnetcore-5.0&tabs=visual-studio

è¿™é‡Œæ·»åŠ ä¸€ä¸ªè§†å›¾é¡µé¢ï¼Œç»“åˆä¸ŠèŠ‚çš„HelloWorldæ ¹æ®è·¯ç”±å®ç°é€»è¾‘é¡µé¢

è§†å›¾æ¨¡æ¿è¿˜æ˜¯Razoråˆ›å»ºçš„ï¼ˆä¸Šä¸€èŠ‚æ˜¯çº¯RazoråŠ ä¸Šé€»è¾‘æ–‡ä»¶ï¼Œè¿™é‡Œé¡µé¢æ˜¯Razorï¼Œé€»è¾‘ç”¨æ§åˆ¶å™¨ï¼‰



### æ›´æ”¹è§†å›¾
Controllers/HelloWorldController.cs
ä¹‹å‰å­—ç¬¦ä¸²æ”¹æˆï¼š
```
public IActionResult Index()
{
    return View();
}
```
1. è°ƒç”¨æ§åˆ¶å™¨çš„Viewæ–¹æ³•
2. ä½¿ç”¨è§†å›¾æ¨¡æ¿ç”ŸæˆHTMLå“åº”
3. é€šå¸¸è¿”å› IActionResult æˆ–ä» ActionResult æ´¾ç”Ÿçš„ç±»ï¼Œè€Œä¸æ˜¯ string è¿™æ ·çš„ç±»å‹ã€‚

Views/HelloWorld/Index.cshtml

```
@{
    ViewData["Title"] = "Index";
}

<h2>Index</h2>

<p>Hello from our View Template!</p>
```

ç„¶åæ‰“å¼€https://localhost:5001/HelloWorldå°±èƒ½æ‰“å¼€é¡µé¢ï¼ŒåŸç†å°±æ˜¯return View()ï¼Œé»˜è®¤ç”¨Indexé¡µé¢çš„å†…å®¹

### æ›´æ”¹å¸ƒå±€
åƒåœ¾æ–‡æ¡£ï¼Œè®²indexè®²ç€è®²ç€è·‘åˆ°layout
Views/Shared/\_Layout.cshtml
Views/\_ViewStart.cshtml
#### æ›´æ”¹è§†å›¾å’Œå¸ƒå±€é¡µé¢
Views/Shared/\_Layout.cshtml

Layout.cshtmlè®©æ¯é¡µæ˜¾ç¤ºç›¸åŒçš„èœå•å¸ƒå±€ï¼ŒMvcMovieï¼ŒHomeå’ŒPrivacy
å¯ä»¥ä¸€ä¸ªåœ°æ–¹æŒ‡å®šå¤šä¸ªåœ°æ–¹ä½¿ç”¨

åˆ«çš„é¡µé¢çš„@RenderBodyæ˜¾ç¤ºç‰¹æœ‰çš„ï¼Œå…¶ä½™æ˜¯å…¬å…±å¸ƒå±€

#### æ›´æ”¹å¸ƒå±€æ–‡ä»¶ä¸­çš„æ ‡é¢˜ã€é¡µè„šå’Œèœå•é“¾æ¥
Views/\_ViewStart.cshtml
- ViewStartæŒ‡å®šäº†å¸ƒå±€åå­— Layout= "\_Layout"
- ViewDataå­—å…¸çš„Titleå±æ€§ï¼Œä¸åŒé¡µé¢å¯ä»¥æŒ‡å®šä¸åŒ
- æ•°æ®çš„ä¸€å°éƒ¨åˆ†å¯ä»¥åœ¨è§†å›¾æŒ‡å®š



### å°†æ•°æ®ä»æ§åˆ¶å™¨ä¼ é€’ç»™è§†å›¾
Controllers/HelloWorldController.cs
Views/HelloWorld/Welcome.cshtml

```cs
using Microsoft.AspNetCore.Mvc;
using System.Text.Encodings.Web;

namespace MvcMovie.Controllers
{
    public class HelloWorldController : Controller
    {
        public IActionResult Index()
        {
            return View();
        }

        public IActionResult Welcome(string name, int numTimes = 1)
        {
            ViewData["Message"] = "Hello " + name;
            ViewData["NumTimes"] = numTimes;

            return View();
        }
    }
}
```


å®šä¹‰Welcomeçš„é¡µé¢é€»è¾‘


```cshtml
@{
    ViewData["Title"] = "Welcome";
}

<h2>Welcome</h2>

<ul>
    @for (int i = 0; i < (int)ViewData["NumTimes"]; i++)
    {
        <li>@ViewData["Message"]</li>
    }
</ul>
```

ç”¨åˆ°äº†æ•°æ®å­—å…¸å˜é‡ é€šè¿‡è·¯ç”±ä¼ é€’ ç»™æ§åˆ¶å™¨



- è¿™é‡Œæ˜¯ä½¿ç”¨**ViewDataå­—å…¸**å°†æ•°æ®ä»æ§åˆ¶å™¨ç»™è§†å›¾
- ä¹‹åå†ä½¿ç”¨è§†å›¾**æ¨¡å‹**å°†æ•°æ®ä»æ§åˆ¶å™¨ä¼ é€’ç»™è§†å›¾ï¼ˆè¿™ä¸ªæ›´ä¼˜å…ˆï¼‰




## æ·»åŠ æ¨¡å‹M
æ·»åŠ ç”¨äºç®¡ç†æ•°æ®åº“çš„ç”µå½±çš„ç±»ï¼ˆæ¨¡å‹ï¼‰

è¿™äº›æ¨¡å‹ä¸Entity Framework Coreä¸€èµ·ä½¿ç”¨æ¥å¤„ç†æ•°æ®åº“

EF Coreæ˜¯å¯¹è±¡å…³ç³»æ˜ å°„æ¡†æ¶ï¼Œå¯ä»¥ç®€åŒ–éœ€è¦ç¼–å†™çš„æ•°æ®è®¿é—®ä»£ç 

å…ˆåˆ›å»ºæ¨¡å‹ç±»ï¼Œç„¶åEF Coreå°†åˆ›å»ºæ•°æ®åº“

### æ“ä½œï¼šæ·»åŠ æ•°æ®æ¨¡å‹ç±»
- åˆ›å»ºModels/Movie.csæ–‡ä»¶
- DataType
- DataAnnotations



### æ“ä½œï¼šæ·»åŠ NuGetåŒ…
æ·»åŠ å‡ ä¸ªåŒ…ç”¨äºç”ŸæˆåŸºæ¶
-   `Microsoft.VisualStudio.Web.CodeGeneration.Design`
-   `Microsoft.EntityFrameworkCore.SqlServer`
-   `Microsoft.EntityFrameworkCore.Design`

å®‰è£…åŸºæ¶ç”Ÿæˆå·¥å…·
`dotnet tool install --global dotnet-aspnet-codegenerator`



### æ“ä½œï¼šç”ŸæˆåŸºæ¶ç”µå½±é¡µé¢
`dotnet-aspnet-codegenerator controller -name MoviesController -m Movie -dc MvcMovieContext --relativeFolderPath Controllers --useDefaultLayout --referenceScriptLibraries -sqlite`

å‚æ•°è¯´æ˜
![[Pasted image 20211130093407.png]]

åŸºæ¶åˆ›å»ºä»¥ä¸‹å†…å®¹ï¼š
1. ç”µå½±æ§åˆ¶å™¨ï¼šControllers/MoviesController.cs
2. â€œåˆ›å»ºâ€ï¼Œâ€œåˆ é™¤â€ï¼Œâ€œè¯¦ç»†ä¿¡æ¯â€ï¼Œâ€œç¼–è¾‘â€å’Œâ€œç´¢å¼•â€é¡µé¢çš„Razorè§†å›¾æ–‡ä»¶Views/Movies/.cshtml
3. æ•°æ®åº“ä¸Šä¸‹æ–‡ç±»ï¼šData/MvcMovieContext.cs


### æ“ä½œï¼šSQLiteç”¨äºå¼€å‘
å’ŒRazorä¸€æ ·ï¼Œåœ¨Startupæ·»åŠ SQLiteå’Œåˆ¤æ–­ä»£ç 

æ“ä½œï¼š
1. åœ¨Startup.csæ–‡ä»¶çš„StartupConfigureServicesä¸­æ³¨å†Œæ•°æ®åº“å°šé›…æ–‡
2. å°†æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²æ·»åŠ åˆ°appsettings.json

Startup.cs
```
services.AddDbContext<MvcMovieContext>(options =>
{
	var connectionString = Configuration.GetConnectionString("MvcMovieContext");

	if (Environment.IsDevelopment())
	{
		options.UseSqlite(connectionString);
	}
	else
	{
		options.UseSqlServer(connectionString);
	}
});
```


appsettings.json
```
{
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "Microsoft": "Warning",
      "Microsoft.Hosting.Lifetime": "Information"
    }
  },
  "AllowedHosts": "*",
  "ConnectionStrings": {
    "MvcMovieContext": "Data Source=MvcMovie.db"
  }
}
```
ï¼ˆè¿™é‡ŒContextç”ŸæˆåŸæ¥æ˜¯éšæœºçš„ï¼Œæ”¹æˆMvcMovie.dbéœ€è¦æ”¹åå­—ç„¶åé‡æ–°ç”Ÿæˆï¼‰






### æ“ä½œï¼šåˆå§‹è¿ç§»
ä½¿ç”¨EF Coreè¿ç§»
```
dotnet ef migrations add InitialCreate
dotnet ef database update
```

ä½œç”¨ï¼š
-   `ef migrations add InitialCreate`ï¼šç”Ÿæˆ Migrations/{timestamp}\_InitialCreate.cs è¿ç§»æ–‡ä»¶ã€‚ `InitialCreate` å‚æ•°æ˜¯è¿ç§»åç§°ã€‚ å¯ä»¥ä½¿ç”¨ä»»ä½•åç§°ï¼Œä½†æ˜¯æŒ‰ç…§æƒ¯ä¾‹ï¼Œä¼šé€‰æ‹©å¯è¯´æ˜è¿ç§»çš„åç§°ã€‚ å› ä¸ºè¿™æ˜¯é¦–æ¬¡è¿ç§»ï¼Œæ‰€ä»¥ç”Ÿæˆçš„ç±»åŒ…å«ç”¨äºåˆ›å»ºæ•°æ®åº“æ¶æ„çš„ä»£ç ã€‚ æ•°æ®åº“æ¶æ„åŸºäºåœ¨ `MvcMovieContext` ç±»ä¸­ï¼ˆä½äº Data/MvcMovieContext.cs æ–‡ä»¶ä¸­ï¼‰ä¸­æŒ‡å®šçš„æ¨¡å‹ã€‚
-   `ef database update`ï¼šå°†æ•°æ®åº“æ›´æ–°åˆ°ä¸Šä¸€ä¸ªå‘½ä»¤åˆ›å»ºçš„æœ€æ–°è¿ç§»ã€‚ æ­¤å‘½ä»¤åœ¨ç”¨äºåˆ›å»ºæ•°æ®åº“çš„ Migrations/{time-stamp}\_InitialCreate.cs æ–‡ä»¶ä¸­è¿è¡Œ `Up` æ–¹æ³•ã€‚ï¼ˆä¿®æ”¹dbæ•°æ®åº“æ–‡ä»¶ï¼‰


### æµ‹è¯•åº”ç”¨
æµ‹è¯•å†™å‡ºæ¥

### æ£€æŸ¥ç”Ÿæˆçš„æ•°æ®åº“ ä¸Šä¸‹æ–‡ç±»å’Œæ³¨å†Œ
çœ‹ä¸€çœ‹ç”Ÿæˆçš„ï¼š
Data/MvcMovieContext.cs

è¿™ä¸ªæ–‡ä»¶åœ¨Startup.csä¾‹çš„sqliteç”¨åˆ°

```
public void ConfigureServices(IServiceCollection services)
{
    services.AddControllersWithViews();
    
    services.AddDbContext<MvcMovieContext>(options =>
    options.UseSqlite(Configuration.GetConnectionString("MvcMovieContext")));
}
```


#### ä½œç”¨
- å¯¹äºEF Coreï¼Œä½¿ç”¨æ¨¡å‹æ‰§è¡Œæ•°æ®è®¿é—®ï¼Œæ¨¡å‹ç”±å®ä½“ç±»å’Œè¡¨ç¤ºæ•°æ®åº“ä¼šè¯çš„ä¸Šä¸‹æ–‡(Context)æ„æˆã€‚
- ä¸Šä¸‹æ–‡å¯¹è±¡å…è®¸æŸ¥è¯¢å¹¶ä¿å­˜æ•°æ®ï¼Œæ´¾ç”Ÿè‡ª[Microsoft.EntityFrameworkCore.DbContext](https://docs.microsoft.com/zh-cn/dotnet/api/microsoft.entityframeworkcore.dbcontext) å¹¶æŒ‡å®šè¦åŒ…å«åœ¨æ•°æ®æ¨¡å‹ä¸­çš„å®ä½“
- ä¸Šä¸‹æ–‡åˆ›å»ºä¸€ä¸ªDBSet\<Movie\>å±æ€§ï¼Œè¡¨ç¤ºæ•°æ®åº“ä¸­çš„ç”µå½±
- ASP.NET Coreé€šè¿‡ä¾èµ–å…³ç³»æ³¨å…¥ç”Ÿæˆã€‚æœåŠ¡ï¼ˆå¦‚æ•°æ®åº“ä¸Šä¸‹æ–‡ï¼‰å¿…é¡»åœ¨Startupä¸­å‘DIæ³¨å†Œéœ€è¦è¿™äº›æœåŠ¡çš„ç»„ä»¶é€šè¿‡å‡½æ•°å‚æ•°æä¾›å“åº”æœåŠ¡
- æ„é€ å‡½æ•°ä½¿ç”¨ä¾èµ–å…³ç³»æ³¨å…¥å°†MvcMovieContextæ•°æ®åº“ä¸Šä¸‹æ–‡æ³¨å…¥åˆ°æ§åˆ¶å™¨ä¸­ã€‚





### æ£€æŸ¥ç”Ÿæˆçš„æ•°æ®åº“è¿æ¥å­—ç¬¦ä¸²
çœ‹appsettings.json

é…ç½®ConnectionStringé”®å€¼
### InitialCreateç±»
çœ‹Migrations/{timestamp}\_InitialCreate.cs
- InitialCreate.Upåˆ›å»ºMovieè¡¨ï¼Œå¹¶å°†IDé…ç½®ä¸ºä¸»é”®
- InitialCreate.Down è¿˜åŸUpè¿ç§»æ‰€åšçš„æ¶æ„æ›´æ”¹

### æ§åˆ¶å™¨ä¸­çš„ä¾èµ–é¡¹æ³¨å…¥
çœ‹Controllers/MoviesController.csï¼ˆä¹Ÿæ˜¯ç”Ÿæˆçš„ï¼‰

ä½¿ç”¨ä¾èµ–å…³ç³»æ³¨å…¥å°†æ•°æ®åº“ä¸Šä¸‹æ–‡MvcMovieContextæ³¨å…¥åˆ°æ§åˆ¶å™¨ä¸­ï¼Œæ•°æ®åº“ä¸Šä¸‹æ–‡å°†åœ¨æ§åˆ¶å™¨ä¸­çš„æ¯ä¸ªCRUDæ–¹æ³•ä¸­ä½¿ç”¨ã€‚


### å¼ºç±»å‹æ¨¡å‹å’Œ@modelæŒ‡ä»¤
è¿™ä¸ªæ˜¯@modelä¼ é€’å¼ºç±»å‹æ¨¡å‹ï¼Œæ¥ä»æ§åˆ¶å™¨ä¼ é€’ç»™è§†å›¾ï¼ˆå¯¹æ¯”ViewDataï¼‰

è¿™é‡Œè§£é‡Šmodelå¦‚ä½•åº”ç”¨çš„


#### Controllers/MoviesController.cs
çœ‹Detailsæ–¹æ³•

- `https://localhost:5001/movies/details/1`ä¼ é€’å‚æ•°ï¼Œ
- `var movie = await _context.Movie .FirstOrDefaultAsync(m => m.Id == id);`æŸ¥è¯¢å­—ç¬¦ä¸²å€¼ç›¸åŒ¹é…çš„ç”µå½±å®ä½“
- `return View(movie);`æ‰¾åˆ°äº†è¿”å›é¡µé¢

#### Views/Movies/Details.cshtml
é¡¶éƒ¨çš„@model
```
@model MvcMovie.Models.Movie
```
æŒ‡å®šè§†å›¾æœŸæœ›çš„å¯¹è±¡ç±»å‹

ç„¶åä¸‹é¢å¯ä»¥ç”¨modelå‚æ•°ï¼Œç”¨DIsplayForå’ŒDisplayName


#### Controllers/MoviesController.cs
å†æ¥çœ‹Indexçš„æ–¹æ³•

```
// GET: Movies
public async Task<IActionResult> Index()
{
    return View(await _context.Movie.ToListAsync());
}
```

è¿™é‡Œåˆ›å»ºäº†Listå¯¹è±¡


#### Views/Movies/Index.cshtml
```
@model IEnumerable<MvcMovie.Models.Movie>
```
@modelæŒ‡ä»¤å…è®¸ä½¿ç”¨å¼ºç±»å‹çš„Modelå¯¹è±¡è®¿é—®æ§åˆ¶å™¨ä¼ é€’ç»™è§†å›¾çš„ç”µå½±åˆ—è¡¨

ç„¶åç”¨foreachå¯¹å¼ºç±»å‹Modelå¾ªç¯éå†

å¯ä»¥ä½¿ç”¨å¼ºç±»å‹Movieå¯¹è±¡ï¼Œç¼–è¯‘å™¨è¿˜èƒ½éªŒè¯ä»£ç ä¸­ä½¿ç”¨çš„ç±»å‹



### Entity Framework Coreçš„SQLæ—¥å¿—è®°å½•
é…ç½®appsettings.Development.json

è®©æ§åˆ¶å°è¾“å‡ºSQLè¯­å¥

## ä½¿ç”¨æ•°æ®åº“
å‰é¢è¯´äº†ï¼Œåœ¨Startup.csçš„ConfigureServicesæ–¹æ³•æ³¨å…¥äº†æ•°æ®åº“ä¸Šä¸‹æ–‡

å¯ä»¥ç”¨DB Browser for SQLiteç®¡ç†æŸ¥çœ‹æ•°æ®åº“

ç„¶ååŠ ä¸€ç‚¹ç©æ³•åŠ æ•°æ®åº“ç§å­
### è®¾å®šæ•°æ®åº“ç§å­
å®šä¹‰Models/SeedData.cså†™åˆå§‹æ•°æ®
### æ·»åŠ ç§å­åˆå§‹è¿™è®¾å®šé¡¹
åœ¨Program.csçš„å†…å®¹æ›¿æ¢ä¸Šä¸Šé¢çš„SeedDataé€»è¾‘


## æ§åˆ¶å™¨æ“ä½œå’Œè§†å›¾
> è¿™é‡Œå¥—è·¯å’ŒRazorä¸€æ ·ï¼Œåªä¸è¿‡Razoré€»è¾‘å†™åœ¨åŒåçš„Edit.cshtml.csï¼Œä¹‹ç±»æ˜¯ç”Ÿæˆçš„å†™åœ¨MovieControlleré‡Œï¼Œå¤šä»‹ç»ä¸€ç‚¹

#### æ”¹åå­—å’Œè·¯ç”±
å’ŒRazorä¸€æ ·RealseData å’Œ 
```
 <td>
    <a href="/Movies/Edit/4"> Edit </a> |
    <a href="/Movies/Details/4"> Details </a> |
    <a href="/Movies/Delete/4"> Delete </a>
</td>
```

StartUp.csä¸­æœ‰è·¯ç”±çš„æ ¼å¼
```
app.UseEndpoints(endpoints =>
{
    endpoints.MapControllerRoute(
        name: "default",
        pattern: "{controller=Home}/{action=Index}/{id?}");
});
```

éƒ½ä¸€æ ·

ä¸‹é¢æ˜¯ä¸ä¸€æ ·çš„ï¼ˆè¿˜æ˜¯ç¿æ™ºæ–‡æ¡£åˆ°å¤„å†™ï¼‰
### ä»¥Edité¡µé¢å’Œæ–¹æ³•ä¸ºä¾‹
#### GET
MovieController.cs
```
// GET: Movies/Edit/5
public async Task<IActionResult> Edit(int? id)
{
    if (id == null)
    {
        return NotFound();
    }

    var movie = await _context.Movie.FindAsync(id);
    if (movie == null)
    {
        return NotFound();
    }
    return View(movie);
}
```

1. getæ–¹æ³•æå–ç”µå½±å¹¶å¡«å……ç”±Edit.cshtml Razoræ–‡ä»¶ç”Ÿæˆçš„ç¼–è¾‘è¡¨å•
2. `_HttpGet Edit_` \_æ–¹æ³•é‡‡ç”¨_ç”µå½± `ID` å‚æ•°ï¼Œä½¿ç”¨Entity Framework `FindAsync` æ–¹æ³•æŸ¥æ‰¾ç”µå½±ï¼Œå¹¶å°†æ‰€é€‰ç”µå½±è¿”å›åˆ°â€œç¼–è¾‘â€è§†å›¾ã€‚ å¦‚æœæ— æ³•æ‰¾åˆ°ç”µå½±ï¼Œåˆ™è¿”å› `NotFound` (HTTP 404)ã€‚

#### POST
MovieController.cs
```
// POST: Movies/Edit/5
// To protect from overposting attacks, please enable the specific properties you want to bind to, for 
// more details see http://go.microsoft.com/fwlink/?LinkId=317598.
[HttpPost]
[ValidateAntiForgeryToken]
public async Task<IActionResult> Edit(int id, [Bind("ID,Title,ReleaseDate,Genre,Price")] Movie movie)
{
    if (id != movie.ID)
    {
        return NotFound();
    }

    if (ModelState.IsValid)
    {
        try
        {
            _context.Update(movie);
            await _context.SaveChangesAsync();
        }
        catch (DbUpdateConcurrencyException)
        {
            if (!MovieExists(movie.ID))
            {
                return NotFound();
            }
            else
            {
                throw;
            }
        }
        return RedirectToAction("Index");
    }
    return View(movie);
}
```
å¤„ç†å·²å‘å¸ƒçš„ç”µå½±å€¼
1. \[Bind\]ç‰¹æ€§é˜²æ­¢è¿‡åº¦å‘å¸ƒï¼Œåªåº”åœ¨\[Bind\]ç‰¹æ€§ä¸­åŒ…å«æƒ³è¦æ›´æ”¹çš„å±æ€§è¯·å‚é˜…[é˜²æ­¢æ§åˆ¶å™¨è¿‡åº¦å‘å¸ƒ](https://docs.microsoft.com/zh-cn/aspnet/mvc/overview/getting-started/getting-started-with-ef-using-mvc/implementing-basic-crud-functionality-with-the-entity-framework-in-asp-net-mvc-application)ã€‚ [ViewModels](https://rachelappel.com/use-viewmodels-to-manage-data-amp-organize-code-in-asp-net-mvc-applications/) 
2. \[HttpPost\]ç‰¹æ€§ï¼ŒæŒ‡å®šåªèƒ½ä¸ºPOSTè¯·æ±‚è°ƒç”¨è¯¥Editæ–¹æ³•ï¼Œ\[HttpGet\]æ˜¯é»˜è®¤è®¾ç½®
3. \[ValidateAntiForgeryToken\]ç‰¹æ€§ç”¨äºé˜²æ­¢è¯·æ±‚ä¼ªé€ ï¼Œä¸cshtmlçš„è¡¨å•æ ‡è®°å¸®åŠ©ç¨‹åºå¯¹åº”:`<form asp-action="Edit">`ï¼Œè¡¨å•æ ‡è®°å¸®åŠ©ç¨‹åºä¼šç”Ÿæˆéšè—çš„æ–¹ä½æ ‡è®°ï¼Œé˜²æ­¢è·¨ç«™è¯·æ±‚ä¼ªé€ xss
4. æ¨¡å‹ç»‘å®šç³»ç»Ÿé‡‡ç”¨å‘å¸ƒçš„è¡¨å•å€¼ï¼Œå¹¶åˆ›å»ºä¸€ä¸ªä½œä¸ºmovieå‚æ•°ä¼ é€’çš„movieå¯¹è±¡`ModelState.IsValid` å±æ€§éªŒè¯è¡¨å•ä¸­æäº¤çš„æ•°æ®æ˜¯å¦å¯ä»¥ç”¨äºä¿®æ”¹ï¼ˆç¼–è¾‘æˆ–æ›´æ–°ï¼‰`Movie` å¯¹è±¡ã€‚é€šè¿‡åˆ™ä¿å­˜ï¼Œé‡å®šå‘åˆ°Indexæ–¹æ³•
5. å®¢æˆ·ç«¯ä¹Ÿå¯ä»¥æœ‰ä¸€äº›æç¤ºï¼Œç¦ç”¨äº†jsï¼ŒæœåŠ¡ç«¯ä¹Ÿä¼šæœ‰æ ¡éªŒéªŒè¯
6. HttpGeté‡‡ç”¨ç±»ä¼¼æ¨¡å¼ï¼Œè·å–ç”µå½±å¯¹è±¡å¹¶ç»™è§†å›¾ï¼ŒGETä¸ä¼šä¿®æ”¹æ•°æ®




#### edit.cshtml
Views/Movies/Edit.cshtml
```
@model MvcMovie.Models.Movie

@{
    ViewData["Title"] = "Edit";
}

<h1>Edit</h1>

<h4>Movie</h4>
<hr />
<div class="row">
    <div class="col-md-4">
        <form asp-action="Edit">
            <div asp-validation-summary="ModelOnly" class="text-danger"></div>
            <input type="hidden" asp-for="Id" />
            <div class="form-group">
                <label asp-for="Title" class="control-label"></label>
                <input asp-for="Title" class="form-control" />
                <span asp-validation-for="Title" class="text-danger"></span>
            </div>
            <div class="form-group">
                <label asp-for="ReleaseDate" class="control-label"></label>
                <input asp-for="ReleaseDate" class="form-control" />
                <span asp-validation-for="ReleaseDate" class="text-danger"></span>
            </div>
            <div class="form-group">
                <label asp-for="Genre" class="control-label"></label>
                <input asp-for="Genre" class="form-control" />
                <span asp-validation-for="Genre" class="text-danger"></span>
            </div>
            <div class="form-group">
                <label asp-for="Price" class="control-label"></label>
                <input asp-for="Price" class="form-control" />
                <span asp-validation-for="Price" class="text-danger"></span>
            </div>
            <div class="form-group">
                <input type="submit" value="Save" class="btn btn-primary" />
            </div>
        </form>
    </div>
</div>

<div>
    <a asp-action="Index">Back to List</a>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
}
```
1. é¡¶ç«¯æœ‰ä¸€ä¸ª@model MvcMovie.Models.Movieè¯­å¥ æŒ‡å®šè§†å›¾æœŸæœ›çš„è§†å›¾æ¨¡æ¿çš„æ¨¡å‹ä¸ºMovieç±»å‹
2. ä½¿ç”¨å‡ ä¸ªæ ‡è®°å¸®åŠ©ç¨‹åºï¼Œæ ‡ç­¾ï¼Œè¾“å…¥ï¼ŒéªŒè¯
3. çœ‹ç”Ÿæˆçš„ä»£ç `<input>` å…ƒç´ ä½äº `HTML <form>` å…ƒç´ ä¸­ï¼Œåè€…çš„ `action` ç‰¹æ€§è®¾ç½®ä¸ºå‘å¸ƒåˆ° `/Movies/Edit/id` URLã€‚ å½“å•å‡» `Save` æŒ‰é’®æ—¶ï¼Œè¡¨å•æ•°æ®å°†å‘å¸ƒåˆ°æœåŠ¡å™¨ã€‚ å…³_é—­_ `_</form>_` \_å…ƒç´ ä¹‹å‰çš„æœ€åä¸€è¡Œæ˜¾ç¤º_[è¡¨å•æ ‡è®°å¸®åŠ©ç¨‹åº](https://docs.microsoft.com/zh-cn/aspnet/core/mvc/views/working-with-forms?view=aspnetcore-5.0)ç”Ÿæˆçš„éšè—çš„ [XSRF](https://docs.microsoft.com/zh-cn/aspnet/core/security/anti-request-forgery?view=aspnetcore-5.0) æ ‡è®°ã€‚

## æ·»åŠ æœç´¢
æ·»åŠ æœç´¢ï¼ŒRazoræ˜¯å¯¹åº”çš„cshtml.csé‡ŒOnGetAsyncåŠ é€»è¾‘ï¼Œè¿™é‡Œæ˜¯æ”¹Controlleræ–¹æ³•ï¼ˆç¡®å®ç»Ÿä¸€åˆ°æ§åˆ¶å™¨äº†ï¼Œä¸ç„¶å…¶ä»–ä½ç½®ä¹±å†™ï¼‰

### Controllers/MoviesController.cs
æ›´æ–°Indexæ–¹æ³•
```
public async Task<IActionResult> Index(string searchString)
{
    var movies = from m in _context.Movie
                 select m;

    if (!String.IsNullOrEmpty(searchString))
    {
        movies = movies.Where(s => s.Title.Contains(searchString));
    }

    return View(await movies.ToListAsync());
}
```

è§£é‡Šï¼š
1. `var movies = from m in _context.Movie             select m;`é€‰æ‹©ç”µå½±
2. Whereæ–¹æ³•æ ¹æ®æœç´¢ç»“æœç»“æœï¼Œé…åˆè¿˜æœ‰å»¶è¿Ÿæ‰§è¡ŒæŸ¥è¯¢ï¼Œï¼ˆContainsæ–¹æ³•å†æ•°æ®åº“ä¸Šè¿è¡Œï¼Œè€Œä¸æ˜¯ç›´æ¥åœ¨csæ‰§è¡Œï¼ŒåŒºåˆ†å¤§å°å†™ï¼‰


ç„¶åæ‹¼æ¥åˆ°å­—ç¬¦ä¸²å°±å¯ä»¥æŸ¥è¯¢äº†
`https://localhost:5000/Movies?searchString=Ghost`

ä¹Ÿå¯ä»¥ç”¨é»˜è®¤è·¯ç”±çš„å¯é€‰`{id}`å ä½ç¬¦

```
app.UseEndpoints(endpoints =>
{
    endpoints.MapControllerRoute(
        name: "default",
        pattern: "{controller=Home}/{action=Index}/{id?}");
});
```

ç›´æ¥ç”¨idæŸ¥è¯¢
`https://localhost:5000/Movies/Ghost`
ä½†æ˜¯å¯¹ç”¨æˆ·ä¸å¥½è¿˜æ˜¯è¦æ”¹æˆsearchStringæ·»åŠ å‚æ•°çš„æ–¹æ³•



### Views/Movies/Index.cshtml
æ·»åŠ ä¸€äº›formæ ‡è®°
```
ViewData["Title"] = "Index";
}

<h2>Index</h2>

<p>
    <a asp-action="Create">Create New</a>
</p>

<form asp-controller="Movies" asp-action="Index">
    <p>
        Title: <input type="text" name="SearchString" />
        <input type="submit" value="Filter" />
    </p>
</form>

<table class="table">
    <thead>
```

formæ˜¯è¡¨å•æ ‡è®°å¸®åŠ©ç¨‹åºï¼Œæäº¤è¡¨å•æ—¶ç­›é€‰å™¨å­—ç¬¦ä¸²ä¼šå‘åˆ°Indexæ“ä½œç„¶åæ›´æ”¹

ç„¶åç¿æ™ºæ–‡æ¡£ç»•æ¥ç»•å»å°±æ˜¯è¯´è¿™é‡Œç‚¹å‡»filteræŒ‰é’®å‘é€çš„æ˜¯é»˜è®¤postè¯·æ±‚ï¼Œè¦åŠ ä¸Š`method="get"`

ä¸ç„¶filteræŒ‰é’®æ˜¯postè¯·æ±‚çš„ï¼Œç„¶åé¢å¤–å®šä¹‰ä¸€ä¸ª\[httppost\]å°±ä¼šå‡ºé—®é¢˜ï¼Œæœ‰æ¯’ï¼Œæ•ˆæœå’Œä½ å‘é€é“¾æ¥ç»™æœ‹å‹ä¸è‡ªå·±filteré¡µé¢æ‰“å¼€ä¸ä¸€æ ·ï¼Œæ‰€ä»¥è¦æ”¹æˆgetï¼Œä»…æ­¤è€Œå·²ï¼ŒåºŸè¯è¿ç¯‡


### æ·»åŠ æŒ‰æµæ´¾æœç´¢
æ”¹ä¸‰ä¸ªåœ°æ–¹ï¼š
1. models
2. æ§åˆ¶å™¨Indexé€»è¾‘
3. è§†å›¾Indexå±•ç¤º

è‡ªå·±å»çœ‹æ”¹å¥½å°±è¡Œ
å°±æ˜¯DisplayForå’ŒDisplayNameForä»€ä¹ˆçš„è‡ªå·±æ
## æ·»åŠ æ–°å­—æ®µ
ç¿æ™ºä¸€æ ·ï¼Œè¿˜æ˜¯åŠ Ratingï¼Œåˆ æ‰å†ç”Ÿæˆ
## æ·»åŠ éªŒè¯
å’ŒRazorä¸€æ ·ï¼Œåªä¸è¿‡è¿™é‡Œæ˜¯æ§åˆ¶å™¨ï¼Œå¯¹æ¯”ä¸€ä¸‹çœ‹çœ‹ç”Ÿæˆçš„POSTçš„Create
```cs
// GET: Movies/Create
public IActionResult Create()
{
    return View();
}

// POST: Movies/Create
[HttpPost]
[ValidateAntiForgeryToken]
public async Task<IActionResult> Create(
    [Bind("ID,Title,ReleaseDate,Genre,Price, Rating")] Movie movie)
{
    if (ModelState.IsValid)
    {
        _context.Add(movie);
        await _context.SaveChangesAsync();
        return RedirectToAction("Index");
    }
    return View(movie);
}
```

å¤šäº†modelStaet.IsValid\

åŒæ ·ä¹Ÿæ˜¯ï¼š
1. å…ˆå®¢æˆ·ç«¯æ£€æµ‹ï¼Œè‹¥ç¦ç”¨js
2. è¿˜æœ‰æœåŠ¡ç«¯æ£€æµ‹ï¼Œå°±æ˜¯ModelState.IsValidæ–¹æ³•
3. ç„¶åç»Ÿä¸€åœ¨modelä¿®æ”¹å°±å¯ä»¥æ·»åŠ éªŒè¯åˆ©äºç»´æŠ¤

### DataTypeç‰¹æ€§
æ·»åŠ ä¸€äº›å…·ä½“çš„çº¦æŸ
å…·ä½“çš„æŸ¥æ–‡æ¡£
## æ£€æŸ¥è¯¦ç»†ä¿¡æ¯å’Œåˆ é™¤
### çœ‹Details
æ²¡ä»€ä¹ˆå¥½çœ‹çš„å°±æ˜¯
`{controller=Home}/{action=Index}/{id?}`
// GET: Movies/Details/5


### çœ‹Delete
å°±æ˜¯æœ‰ä¸¤ä¸ª
ä¸€ä¸ªæ˜¯
// GET: Movies/Delete/5

å¦ä¸€ä¸ªæ˜¯
// POST: Movies/Delete/5


GETæ˜¯å±•ç¤ºåˆ é™¤é¡µé¢
POSTæ˜¯å‘å¸ƒåˆ é™¤è¯·æ±‚ï¼Œæœ‰ä¸€ä¸ªDeleteConfirmedï¼Œä¸ºPOSTæä¾›ä¸€ä¸ªå”¯ä¸€çš„ç­¾åï¼Œæ˜¯é‡è½½ä¸èƒ½å¤Ÿé‡åï¼ŒåŠ äº†ä¸€ä¸ªâ€œActionName("Delete")â€å±æ€§ï¼Œæ–¹ä¾¿postè¯·æ±‚æ‰¾åˆ°DeleteConfirmedæ–¹æ³•

è¿™ä¸ªæ˜¯åç§°å’Œç­¾åï¼Œåœ¨é‡è½½çš„åº”ç”¨ï¼Œ


![[Pasted image 20211130155230.png]]


å¯¹äºåç§°å’Œç­¾åç›¸åŒçš„ï¼Œä¹Ÿå¯ä»¥åŠ ä¸€äº›é¢å¤–çš„å‚æ•°æ–¹ä¾¿é‡è½½

```
// POST: Movies/Delete/6
[HttpPost]
[ValidateAntiForgeryToken]
public async Task<IActionResult> Delete(int id, bool notUsed)
```
