---
title: æ¯•ä¸šè®¾è®¡5
categories:
  - ä¸ªäººæå‡
  - æ¯•ä¸šè®¾è®¡
thumbnailImage: 'http://cdn.ekko306.top/cover/Red%20Pill%20Blues%20%28Deluxe%29.jpg'
date: 2021-12-02 15:31:24
tags:
coverImage:
coverCaption:
gallery:
---

Web API
<!-- more -->
<!-- toc -->
# ç®€ä»‹
ä½¿ç”¨Web APIåº”ç”¨

# ä½¿ç”¨æ§åˆ¶å™¨åˆ›å»ºWeb API
ğŸ¦„ï¼š[githubåœ°å€:TodoApi](https://github.com/Ekko306/SignalR_Practice/tree/main/TodoApi)
ğŸ½ï¼š[æ–‡æ¡£åœ°å€](https://docs.microsoft.com/zh-cn/aspnet/core/tutorials/first-web-api?view=aspnetcore-3.1&tabs=visual-studio-mac)
## æ¦‚è¿°
åˆ›å»ºäº”ä¸ªAPI
![[Pasted image 20211202154941.png]]
## å…ˆå†³æ¡ä»¶
- visual studio for mac
- .NET Core 3.1 SDK

## åˆ›å»ºWebé¡¹ç›®
é€‰æ‹©APIï¼Œåå«â€œTodoApiâ€
### æµ‹è¯•API
æ‰“å¼€`https://localhost:5001/WeatherForecast`

è¿”å›æµ‹è¯•çš„json


## æ·»åŠ æ¨¡å‹ç±»
æ¨¡å‹æ˜¯ä¸€ç»„è¡¨ç¤ºåº”ç”¨ç®¡ç†çš„æ•°æ®çš„ç±»ï¼Œæ­¤åº”ç”¨çš„æ¨¡å‹æ˜¯å•ä¸ªTodoItemç±»
åˆ›å»ºModels/TodoItem.cs
```
public class TodoItem
{
    public long Id { get; set; }
    public string Name { get; set; }
    public bool IsComplete { get; set; }
}
```

IDç”¨ä½œå…³ç³»æ•°æ®åº“ä¸­çš„æƒŸä¸€é”®


## æ·»åŠ æ•°æ®åº“ä¸Šä¸‹æ–‡
æ·»åŠ Models/TodoContext.cs

æ´¾ç”Ÿè‡ª`Microsoft.EntityFrameworkCore.DbContext`ç±»

```
using Microsoft.EntityFrameworkCore;

namespace TodoApi.Models
{
    public class TodoContext : DbContext
    {
        public TodoContext(DbContextOptions<TodoContext> options)
            : base(options)
        {
        }

        public DbSet<TodoItem> TodoItems { get; set; }
    }
}
```


## æ³¨å†Œæ•°æ®åº“ä¸Šä¸‹æ–‡
åœ¨Startup.csæ·»åŠ æ•°æ®åº“ä¸Šä¸‹æ–‡
```
using Microsoft.EntityFrameworkCore;
using TodoApi.Models;

services.AddDbContext<TodoContext>(opt => opt.UseInMemoryDatabase("TodoList"));
```
## æ„å»ºæ§åˆ¶å™¨
å…ˆå®‰è£…ä¸€äº›åŒ…
å†æ‰§è¡Œ`dotnet aspnet-codegenerator controller -name TodoItemsController -async -api -m TodoItem -dc TodoContext -outDir Controllers`

ä¼šç”ŸæˆControllers/TodoItemsController.cs
1. æœ‰\[ApiController\] è¯´æ˜æ§åˆ¶å™¨å“åº”Web APIè¯·æ±‚
2. ä¼šå°†TodoContextæ³¨å…¥åˆ°æ§åˆ¶å™¨ä¸­ï¼Œè®©æ§åˆ¶å™¨ä½¿ç”¨æ•°æ®åº“ä¸Šä¸‹æ–‡


å¯¹äºæ§åˆ¶å™¨ï¼ŒMVCçš„æ§åˆ¶å™¨æœ‰\[action\]ï¼Œä½†æ˜¯APIçš„æ§åˆ¶å™¨æ²¡æœ‰\[action\]

## æ£€æŸ¥PostTodoItem createæ–¹æ³•
```
// POST: api/TodoItems
[HttpPost]
public async Task<ActionResult<TodoItem>> PostTodoItem(TodoItem todoItem)
{
    _context.TodoItems.Add(todoItem);
    await _context.SaveChangesAsync();

    //return CreatedAtAction("GetTodoItem", new { id = todoItem.Id }, todoItem);
    return CreatedAtAction(nameof(GetTodoItem), new { id = todoItem.Id }, todoItem);
}
```
- æ˜¯HTTP POSTçš„æ–¹æ³•ï¼Œè¯·æ±‚æ­£æ–‡åå»å¾…åŠäº‹é¡¹
- æœ‰ä¸ªå†…ç½®çš„CreatedAtActionæ–¹æ³•ï¼Œå†…ç½®äº†å¾ˆå¤šæ“ä½œï¼š
	-   å¦‚æœæˆåŠŸï¼Œåˆ™è¿”å› HTTP 201 çŠ¶æ€ä»£ç ã€‚ HTTP 201 æ˜¯åœ¨æœåŠ¡å™¨ä¸Šåˆ›å»ºæ–°èµ„æºçš„ HTTP POST æ–¹æ³•çš„æ ‡å‡†å“åº”ã€‚
	-   å‘å“åº”æ·»åŠ [ä½ç½®](https://developer.mozilla.org/docs/Web/HTTP/Headers/Location)æ ‡å¤´ã€‚ `Location` æ ‡å¤´æŒ‡å®šæ–°å»ºçš„å¾…åŠäº‹é¡¹çš„ [URI](https://developer.mozilla.org/docs/Glossary/URI)ã€‚ æœ‰å…³è¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚é˜…[åˆ›å»ºçš„ 10.2.2 201](https://www.w3.org/Protocols/rfc2616/rfc2616-sec10.html)ã€‚
	-   å¼•ç”¨ `GetTodoItem` æ“ä½œä»¥åˆ›å»º `Location` æ ‡å¤´çš„ URIã€‚ C# `nameof` å…³é”®å­—ç”¨äºé¿å…åœ¨ `CreatedAtAction` è°ƒç”¨ä¸­ç¡¬ç¼–ç æ“ä½œåç§°ã€‚

## å®‰è£…Postman
ç¦ç”¨SSLè¯ä¹¦éªŒè¯
### é€šè¿‡Postmanæµ‹è¯•PostTodoItem
æµ‹è¯•å‘ç°POSTæˆåŠŸ

### ä½¿ç”¨Postmanæµ‹è¯•ä½ç½®æ ‡å¤´URI
ç”¨GETè¯·æ±‚`https://localhost:5001/api/todoitems/1`ï¼Œå‘ç°å¾—åˆ°postçš„å†…å®¹

ï¼ˆä¸èƒ½ç”¨POSTè¯·æ±‚è¿™ä¸ªåœ°å€ï¼Œå¸¦idçš„åªèƒ½GETï¼ŒPUTï¼ŒDELETEï¼ŒæŠ¥é”™405ï¼‰

## æ£€æŸ¥GETæ–¹æ³•
GETæœ‰ä¸¤ç±»æ–¹æ³•ï¼š
-   `GET /api/todoitems`
-   `GET /api/todoitems/{id}`

### ä½¿ç”¨Postmanæµ‹è¯•GET
æ­¤åº”ç”¨ä½¿ç”¨å†…å­˜ä¸­çš„æ•°æ®åº“



## è·¯ç”±å’ŒURLè·¯å¾„
\[HttpGet\]å±æ€§è¡¨ç¤ºå“åº”HTTP GETè¯·æ±‚çš„æ–¹æ³•ï¼Œå¦‚ä¸‹æ‰€ç¤º
æœ€å¼€å¤´å†™
`[Route("api/[controller]")]`


- æ§åˆ¶å™¨çš„Routeä¸­ä»¥æ¨¡æ¿å­—ç¬¦ä¸²å¼€å¤´
- \[controller\]åç§°ä¸º"TodoItems"
- \[HttpGet\]å±æ€§å…·æœ‰è·¯ç”±æ¨¡æ¿ï¼ˆä¾‹å¦‚`[HttpGet("products")]`ï¼‰ï¼Œåˆ™æŠŠproductsè¿½åŠ åˆ°è·¯ç”±
- å¢åŠ {id}æ˜¯ä¼šæä¾›å ä½ç¬¦å˜é‡ä¾‹å¦‚`[HttpGet("{id}")]`

## è¿”å›å€¼
`GetTodoItems` å’Œ `GetTodoItem` æ–¹æ³•çš„è¿”å›ç±»å‹æ˜¯ ActionResult\<T\> ç±»å‹ã€‚ ASP.NET Core è‡ªåŠ¨å°†å¯¹è±¡åºåˆ—åŒ–ä¸º JSONï¼Œå¹¶å°† JSON å†™å…¥å“åº”æ¶ˆæ¯çš„æ­£æ–‡ä¸­ã€‚

å†…å®¹æ²¡æœ‰é”™è¯¯è¿”å›200ï¼Œæœ‰é”™è¯¯è¿”å›500

ActionResultå¯ä»¥è¡¨ç¤ºå¤§èŒƒå›´çš„HTTPçŠ¶æ€ä»£ç ï¼Œä¾‹å¦‚ï¼Œ`GetTodoItem`å¯ä»¥è¿”å›ä¸¤ä¸ªä¸åŒçš„çŠ¶æ€å€¼ï¼š
- æ²¡æœ‰ä¸IDåŒ¹é…ï¼Œè¿”å›404 not found
- å¦åˆ™è¿”å›200


## PutTodoItemæ–¹æ³•

PutTodoItemä¸PostTodoItemç±»ä¼¼ï¼Œä½†æ˜¯ä½¿ç”¨çš„æ˜¯HTTP PUTï¼Œå“åº”æ˜¯204ï¼ˆæ— å†…å®¹ï¼‰ï¼Œè¦æ”¯æŒéƒ¨åˆ†æ›´æ–°ä½¿ç”¨HTTP Patch

### æµ‹è¯•PutTOdoItemæ–¹æ³•
postmanæˆåŠŸï¼Œå…ˆç¡®ä¿æœ‰IDçš„æ•°æ®

## DeleteTodoItemæ–¹æ³•
æ£€æŸ¥`DeleteTodoItem`æ–¹æ³•ï¼š

### æµ‹è¯•DeleteTodoItem
ç¡®å®šè·¯ç”±å’ŒDELETEæ–¹æ³•

## é˜²æ­¢è¿‡åº¦å‘å¸ƒ
ç›®å‰TodoItemå¯¹è±¡å…¬å¼€äº†å…¨éƒ¨æ•°æ®ï¼Œä½†æ˜¯ä¸ºäº†å®‰å…¨æ€§ï¼Œè¦æ”¹åŠ¨ã€‚

æ¨¡å‹çš„é€šå¸¸ç§°ä¸ºï¼š
1. **æ•°æ®ä¼ è¾“å¯¹è±¡**
2. è¾“å…¥æ¨¡å‹
3. è§†å›¾æ¨¡å‹


æœ¬æ–‡ä½¿ç”¨DTOé˜²æ­¢è¿‡åº¦å‘å¸ƒï¼Œéšè—å®¢æˆ·ç«¯ä¸åº”æŸ¥çœ‹çš„å±æ€§

TodoItemç±»
```
public class TodoItem
{
    public long Id { get; set; }
    public string Name { get; set; }
    public bool IsComplete { get; set; }
    public string Secret { get; set; }
}
```


DTOæ¨¡å‹
```
public class TodoItemDTO
{
    public long Id { get; set; }
    public string Name { get; set; }
    public bool IsComplete { get; set; }
}
```


æ›´æ–°`TodoItemsController`ä½¿ç”¨TodoItemDTO
## ä½¿ç”¨JavaScriptè°ƒç”¨Web API
æ·»åŠ ä¸€äº›WWWROOTé¡µé¢
## å‘Web APIæ·»åŠ èº«ä»½éªŒè¯æ”¯æŒ
å¯ä»¥æ·»åŠ ä¸€äº›éªŒè¯ï¼š
-   èº«ä»½éªŒè¯å³æœåŠ¡ (AaaS)
-   è·¨å¤šä¸ªåº”ç”¨ç¨‹åºç±»å‹çš„å•ä¸€ç™»å½•/æ³¨é”€ (SSO)
-   API çš„è®¿é—®æ§åˆ¶
-   Federation Gateway


# ä½¿ç”¨MongoDBçš„Web API
ğŸ¦„ï¼š[githubåœ°å€:BooksApi](https://github.com/Ekko306/SignalR_Practice/tree/main/BooksApi)
ğŸ½ï¼š[æ–‡æ¡£åœ°å€](https://docs.microsoft.com/zh-cn/aspnet/core/tutorials/first-mongo-app?view=aspnetcore-3.1&tabs=visual-studio-mac)
ä¹‹å‰çš„çš„æ•°æ®åº“æ˜¯åœ¨å†…å­˜é‡Œçš„ï¼Œè¿™é‡Œç”¨æ•°æ®åº“

## å…ˆå†³æ¡ä»¶
- .NET Core SDK
- visual studio for mac
- MongoDB

## é…ç½®MongoDB
mongodå¯åŠ¨æ•°æ®åº“ï¼ŒæŒ‰ç…§å‘½ä»¤åŠ å…¥åˆå§‹æ•°æ®
```
{
  "_id" : ObjectId("5bfd996f7b8e48dc15ff215d"),
  "Name" : "Design Patterns",
  "Price" : 54.93,
  "Category" : "Computers",
  "Author" : "Ralph Johnson"
}
{
  "_id" : ObjectId("5bfd996f7b8e48dc15ff215e"),
  "Name" : "Clean Code",
  "Price" : 43.15,
  "Category" : "Computers",
  "Author" : "Robert C. Martin"
}
```

## åˆ›å»ºASP.NET COre Web APIé¡¹ç›®
åå­—å«åšBooksApi

## æ·»åŠ å®ä½“æ¨¡å‹
æ·»åŠ Models/Book.cs

```
using MongoDB.Bson;
using MongoDB.Bson.Serialization.Attributes;

namespace BooksApi.Models
{
    public class Book
    {
        [BsonId]
        [BsonRepresentation(BsonType.ObjectId)]
        public string Id { get; set; }

        [BsonElement("Name")]
        public string BookName { get; set; }

        public decimal Price { get; set; }

        public string Category { get; set; }

        public string Author { get; set; }
    }
}
```

ä¸Šé¢æœ‰ç‰¹åˆ«çš„ï¼š
1. IDå±æ€§ï¼Œéœ€è¦åœ¨å…¬å…±è¯­è¨€è¿è¡Œæ—¶ï¼ˆCRLï¼‰å¯¹è±¡æ˜ å°„åˆ°MongoDBé›†åˆæ—¶ä½¿ç”¨
2. ä½¿ç”¨\[BsonId\]è¿›è¡Œæ‰¹æ³¨ï¼ŒæŒ‡å®šä¸ºæ–‡æ¡£çš„ä¸»é”®
3. ä½¿ç”¨\[BsonRepresentation(BsonType.ObjectID)\]è¿›è¡Œæ‰¹æ³¨ï¼Œå…è®¸å°†å‚æ•°ä½œä¸ºç±»å‹stringç»“æ„ä¼ é€’ï¼Œmongoå¤„ç†stringåˆ°ObjectIdçš„è½¬æ¢
4. BookNameå±æ€§ä½¿ç”¨\[BsonElement\]ç‰¹æ€§æ‰¹æ³¨ï¼ŒNameæ˜¯MongoDBä¸­çš„åç§°

å¥‡è‘© å¯¹åº”

## æ·»åŠ é…ç½®æ¨¡å‹
åœ¨appsettings.jsoné…ç½®æ•°æ®åº“
```
"BookstoreDatabaseSettings": {
    "BooksCollectionName": "Books",
    "ConnectionString": "mongodb://localhost:27017",
    "DatabaseName": "BookstoreDb"
  }
```

è¿˜è¦å¢åŠ Models/BookstoreDatabaseSettings.cs
```
namespace BooksApi.Models
{
    public class BookstoreDatabaseSettings : IBookstoreDatabaseSettings
    {
        public string BooksCollectionName { get; set; }
        public string ConnectionString { get; set; }
        public string DatabaseName { get; set; }
    }

    public interface IBookstoreDatabaseSettings
    {
        string BooksCollectionName { get; set; }
        string ConnectionString { get; set; }
        string DatabaseName { get; set; }
    }
}
```

ä½œç”¨æ˜¯appsetting.jsoné‡Œçš„æ˜¯BookstoreDatabaseSettingså±æ€§å€¼ï¼Œç®€åŒ–JSONåˆ°C#çš„æ˜ å°„

ç„¶åStartup.ConfigureServiceså°±å¯ä»¥ä½¿ç”¨ä¸Šé¢å®šä¹‰çš„äº†
```
public void ConfigureServices(IServiceCollection services)
{
    // requires using Microsoft.Extensions.Options
    services.Configure<BookstoreDatabaseSettings>(
        Configuration.GetSection(nameof(BookstoreDatabaseSettings)));

    services.AddSingleton<IBookstoreDatabaseSettings>(sp =>
        sp.GetRequiredService<IOptions<BookstoreDatabaseSettings>>().Value);

    services.AddControllers();
}
```
ç„¶åç‹—å±ä¸é€šçš„è§£é‡Šï¼š
-   appsettings.json æ–‡ä»¶çš„ `BookstoreDatabaseSettings` éƒ¨åˆ†ç»‘å®šåˆ°çš„é…ç½®å®ä¾‹åœ¨ä¾èµ–å…³ç³»æ³¨å…¥ (DI) å®¹å™¨ä¸­æ³¨å†Œã€‚ ä¾‹å¦‚ï¼Œ`BookstoreDatabaseSettings` å¯¹è±¡çš„ `ConnectionString` å±æ€§ä½¿ç”¨ appsettings.json ä¸­çš„ `BookstoreDatabaseSettings:ConnectionString` å±æ€§è¿›è¡Œå¡«å……ã€‚
-   `IBookstoreDatabaseSettings` æ¥å£ä½¿ç”¨å•ä¸€å®ä¾‹[æœåŠ¡ç”Ÿå­˜æœŸ](https://docs.microsoft.com/zh-cn/aspnet/core/fundamentals/dependency-injection?view=aspnetcore-3.1#service-lifetimes)åœ¨ DI ä¸­æ³¨å†Œã€‚ åœ¨æ³¨å…¥æ—¶ï¼Œæ¥å£å®ä¾‹æ—¶å°†è§£æä¸º `BookstoreDatabaseSettings` å¯¹è±¡ã€‚

å…ˆæŠ„ç€ç”¨å†ç†è§£å§

æœ€ååœ¨Startup.csé¡¶éƒ¨æ·»åŠ ï¼Œå°±èƒ½ä½¿ç”¨æ¨¡å‹äº†
```
using BooksApi.Models;
```


## æ·»åŠ CRUDæ“ä½œæœåŠ¡
1. æŠ„ä»£ç æ·»åŠ åˆ°Services/BookService.cs
2. å°†ä»£ç æ·»åŠ åˆ°Startup.ConfigureServicesï¼Œ`using BooksApi.Services`` services.AddSingleton<BookService>();`


ç„¶ååƒåœ¾è§£é‡Šï¼Œæ–‡æ¡£åˆ°å¤„ä¹±å†™ï¼Œæ€ç»´æ··ä¹±å“ˆå“ˆï¼š
### Services/BookService.cs
1. BookServiceç±»ä½¿ç”¨äº†MongoDB.Driverå¯¹æ•°æ®åº“æ‰§è¡ŒCRUDæ“ä½œ
2. MongoClientè¯»å–ç”¨äºæ‰§è¡Œæ•°æ®åº“æ“ä½œçš„æœåŠ¡å™¨å®ä¾‹`var client = new MongoClient(settings.ConnectionString);`
3. IMongoDatabaseï¼šè¡¨ç¤ºç”¨äºæ‰§è¡Œæ“ä½œçš„ Mongo æ•°æ®åº“ã€‚ æœ¬æ•™ç¨‹åœ¨ç•Œé¢ä¸Šä½¿ç”¨æ³›å‹ GetCollection\<TDocument\>(collection) æ–¹æ³•æ¥è·å–å¯¹ç‰¹å®šé›†åˆä¸­çš„æ•°æ®çš„è®¿é—®æƒé™ã€‚ è°ƒç”¨æ­¤æ–¹æ³•åï¼Œå¯¹é›†åˆæ‰§è¡Œ CRUD æ“ä½œã€‚ åœ¨ GetCollection\<TDocument\>(collection) æ–¹æ³•è°ƒç”¨ä¸­ï¼š
	1. collection è¡¨ç¤ºé›†åˆåç§°
	2. TDocument è¡¨ç¤ºå­˜å‚¨åœ¨é›†åˆä¸­çš„ CLR å¯¹è±¡ç±»å‹ã€‚



GetCollection\<TDocument\>(collection) è¿”å›è¡¨ç¤ºé›†åˆçš„ MongoCollection å¯¹è±¡ã€‚ åœ¨æœ¬æ•™ç¨‹ä¸­ï¼Œå¯¹é›†åˆè°ƒç”¨ä»¥ä¸‹æ–¹æ³•ï¼š

- DeleteOneï¼šåˆ é™¤ä¸æä¾›çš„æœç´¢æ¡ä»¶åŒ¹é…çš„å•ä¸ªæ–‡æ¡£ã€‚
- Find\<TDocument\>ï¼šè¿”å›é›†åˆä¸­ä¸æä¾›çš„æœç´¢æ¡ä»¶åŒ¹é…çš„æ‰€æœ‰æ–‡æ¡£ã€‚
- InsertOneï¼šæ’å…¥æä¾›çš„å¯¹è±¡ä½œä¸ºé›†åˆä¸­çš„æ–°æ–‡æ¡£ã€‚
- ReplaceOneï¼šå°†ä¸æä¾›çš„æœç´¢æ¡ä»¶åŒ¹é…çš„å•ä¸ªæ–‡æ¡£æ›¿æ¢ä¸ºæä¾›çš„å¯¹è±¡ã€‚


### Startup.ConfigureServices
ä¸Šé¢ä»£ç å‘DIæ³¨å†Œäº†BookServiceç±»ï¼Œä»¥æ”¯æŒæ¶ˆè´¹ç±»ä¸­çš„æ„é€ å‡½æ•°æ³¨å…¥ï¼Œå†‰ä¹‰å®ä¾‹æœåŠ¡ç”Ÿå­˜æœŸæ˜¯æœ€åˆé€‚çš„ï¼Œå› ä¸ºBookServiceç›´æ¥ä¾èµ–äºMongoClientã€‚æ ¹æ®å®˜æ–¹çš„Mongo Clienté‡ç”¨å‡†åˆ™ï¼Œåº”ä½¿ç”¨å•ä¸€å®ä¾‹æœåŠ¡ç”Ÿå­˜æœŸåœ¨DIä¸­æ³¨å†ŒMongoClient



## æ·»åŠ æ§åˆ¶å™¨
æŠ„ä»£ç åˆ°Controllers/BooksControllerï¼Œä½œç”¨ï¼ˆcontrolleré‡Œç”¨serviceå’Œmodelï¼‰ï¼š
1. ä½¿ç”¨BookServiceç±»æ‰§è¡ŒCRUDæ“ä½œ
2. åŒ…å«æ“ä½œæ–¹æ³•ä»¥æ”¯æŒGETã€POSTå’ŒPUTå’ŒDELETE HTTPè¯·æ±‚
3. åœ¨Createæ“ä½œæ–¹æ³•ä¸­è°ƒç”¨CreatedAtRouteï¼Œä»¥è¿”å›HTTP 201å“åº”ï¼ŒçŠ¶æ€ä»£ç 201æ˜¯åœ¨æœåŠ¡å™¨ä¸Šåˆ›å»ºæ–°èµ„æºçš„HTTP POSTæ–¹æ³•çš„æ ‡å‡†å“åº”ï¼ŒCreatedè¿˜ä¼šå°†Locationæ ‡å¤´æ·»åŠ åˆ°å“åº”ä¸­ï¼ˆheaderï¼‰ã€‚LocationæŒ‡å®šæ–°å»ºçš„URI

## æµ‹è¯•Web API
æµ‹è¯•`http://localhost:<port>/api/books`å¯ç”¨

æµ‹è¯•`http://localhost:<port>/api/books/{id here}`å¯ç”¨
## é…ç½®JSONåºåˆ—åŒ–é€‰é¡¹
ä¿®æ”¹è¿”å›å€¼çš„åå­—bookName=>Nameæ¥æ»¡è¶³åºåˆ—åŒ–è¦æ±‚

åŸå› ï¼š
-   åº”æ›´æ”¹å±æ€§åç§°çš„é»˜è®¤é©¼å³°å¼å¤§å°å†™é£æ ¼ï¼Œä»¥åŒ¹é… CLR å¯¹è±¡å±æ€§åç§°çš„ Pascal å¤§å°å†™ã€‚
-   `bookName` å±æ€§åº”ä½œä¸º `Name` è¿”å›ã€‚

æ­¥éª¤ï¼š
1. æ·»åŠ  å°†åŒ…å¼•ç”¨æ·»åŠ `Microsoft.AspNetCore.Mvc.NewtonsoftJson`
2. AddControllersé‡Œè°ƒç”¨`services.AddControllers()  .AddNewtonsoftJson(options => options.UseMemberCasing());`
3. Models/Book.csï¼Œä½¿ç”¨\[JsonProperty\]æ‰¹æ³¨BookNameå±æ€§, `[JsonProperty("Name")]`
4. åœ¨Models/Book.csé¡¶éƒ¨æ·»åŠ ä»£ç ï¼Œè§£æJSONProperty`using Newtonsoft.Json;`


## å‘Web APIæ·»åŠ èº«ä»½éªŒè¯
å¾…å®š

# é¢å‘JavaScriptçš„Web API
ğŸ¦„ï¼š[githubåœ°å€:TodoApi](https://github.com/Ekko306/SignalR_Practice/tree/main/TodoApi)ï¼ˆå’Œä½¿ç”¨æ§åˆ¶å™¨åˆ›å»ºWeb APIå…±ç”¨ï¼‰
ğŸ½ï¼š[æ–‡æ¡£åœ°å€](https://docs.microsoft.com/zh-cn/aspnet/core/tutorials/web-api-javascript?view=aspnetcore-3.1)
è¿™é‡Œæ˜¯ç”¨JavaScriptè°ƒç”¨Web API

Fetch APIçš„fetchå‡½æ•°å¯ä»¥å¯åŠ¨æ¯ä¸ªHTTPè¯·æ±‚


## 1 é€‰æ‹©wwwrootä½œä¸ºwebå¯åŠ¨
Startup.csçš„Configureå†™å…¥ï¼š
```cs
public void Configure(IApplicationBuilder app, IWebHostEnvironment env)
{
    if (env.IsDevelopment())
    {
        app.UseDeveloperExceptionPage();
    }

    app.UseDefaultFiles();
    app.UseStaticFiles();

    app.UseHttpsRedirection();

    app.UseRouting();

    app.UseAuthorization();

    app.UseEndpoints(endpoints =>
    {
        endpoints.MapControllers();
    });
}
```

## 2 åˆ›å»ºweb
wwwroot/index.html:
```html
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>To-do CRUD</title>
    <link rel="stylesheet" href="css/site.css" />
</head>
<body>
    <h1>To-do CRUD</h1>
    <h3>Add</h3>
    <form action="javascript:void(0);" method="POST" onsubmit="addItem()">
        <input type="text" id="add-name" placeholder="New to-do">
        <input type="submit" value="Add">
    </form>

    <div id="editForm">
        <h3>Edit</h3>
        <form action="javascript:void(0);" onsubmit="updateItem()">
            <input type="hidden" id="edit-id">
            <input type="checkbox" id="edit-isComplete">
            <input type="text" id="edit-name">
            <input type="submit" value="Save">
            <a onclick="closeInput()" aria-label="Close">&#10006;</a>
        </form>
    </div>

    <p id="counter"></p>

    <table>
        <tr>
            <th>Is Complete?</th>
            <th>Name</th>
            <th></th>
            <th></th>
        </tr>
        <tbody id="todos"></tbody>
    </table>

    <script src="js/site.js" asp-append-version="true"></script>
    <script type="text/javascript">
        getItems();
    </script>
</body>
</html>
```


wwwroot/js/site.js
```js
const uri = 'api/todoitems';
let todos = [];

function getItems() {
  fetch(uri)
    .then(response => response.json())
    .then(data => _displayItems(data))
    .catch(error => console.error('Unable to get items.', error));
}

function addItem() {
  const addNameTextbox = document.getElementById('add-name');

  const item = {
    isComplete: false,
    name: addNameTextbox.value.trim()
  };

  fetch(uri, {
    method: 'POST',
    headers: {
      'Accept': 'application/json',
      'Content-Type': 'application/json'
    },
    body: JSON.stringify(item)
  })
    .then(response => response.json())
    .then(() => {
      getItems();
      addNameTextbox.value = '';
    })
    .catch(error => console.error('Unable to add item.', error));
}

function deleteItem(id) {
  fetch(`${uri}/${id}`, {
    method: 'DELETE'
  })
  .then(() => getItems())
  .catch(error => console.error('Unable to delete item.', error));
}

function displayEditForm(id) {
  const item = todos.find(item => item.id === id);
  
  document.getElementById('edit-name').value = item.name;
  document.getElementById('edit-id').value = item.id;
  document.getElementById('edit-isComplete').checked = item.isComplete;
  document.getElementById('editForm').style.display = 'block';
}

function updateItem() {
  const itemId = document.getElementById('edit-id').value;
  const item = {
    id: parseInt(itemId, 10),
    isComplete: document.getElementById('edit-isComplete').checked,
    name: document.getElementById('edit-name').value.trim()
  };

  fetch(`${uri}/${itemId}`, {
    method: 'PUT',
    headers: {
      'Accept': 'application/json',
      'Content-Type': 'application/json'
    },
    body: JSON.stringify(item)
  })
  .then(() => getItems())
  .catch(error => console.error('Unable to update item.', error));

  closeInput();

  return false;
}

function closeInput() {
  document.getElementById('editForm').style.display = 'none';
}

function _displayCount(itemCount) {
  const name = (itemCount === 1) ? 'to-do' : 'to-dos';

  document.getElementById('counter').innerText = `${itemCount} ${name}`;
}

function _displayItems(data) {
  const tBody = document.getElementById('todos');
  tBody.innerHTML = '';

  _displayCount(data.length);

  const button = document.createElement('button');

  data.forEach(item => {
    let isCompleteCheckbox = document.createElement('input');
    isCompleteCheckbox.type = 'checkbox';
    isCompleteCheckbox.disabled = true;
    isCompleteCheckbox.checked = item.isComplete;

    let editButton = button.cloneNode(false);
    editButton.innerText = 'Edit';
    editButton.setAttribute('onclick', `displayEditForm(${item.id})`);

    let deleteButton = button.cloneNode(false);
    deleteButton.innerText = 'Delete';
    deleteButton.setAttribute('onclick', `deleteItem(${item.id})`);

    let tr = tBody.insertRow();
    
    let td1 = tr.insertCell(0);
    td1.appendChild(isCompleteCheckbox);

    let td2 = tr.insertCell(1);
    let textNode = document.createTextNode(item.name);
    td2.appendChild(textNode);

    let td3 = tr.insertCell(2);
    td3.appendChild(editButton);

    let td4 = tr.insertCell(3);
    td4.appendChild(deleteButton);
  });

  todos = data;
}
```


wwwroot/site.cs
```css
input[type='submit'], button, [aria-label] {
    cursor: pointer;
}

#editForm {
    display: none;
}

table {
    font-family: Arial, sans-serif;
    border: 1px solid;
    border-collapse: collapse;
}

th {
    background-color: #f8f8f8;
    padding: 5px;
}

td {
    border: 1px solid;
    padding: 5px;
}
```


## 3 å¯åŠ¨é¡¹ç›®
æ‰“å¼€Properties/launchSettings.json
åˆ é™¤`launchUrl`æ¥åœ¨é»˜è®¤æ–‡ä»¶index.htmlå¼ºåˆ¶æ‰“å¼€åº”ç”¨


## è¯´æ˜Web APIè¯·æ±‚
getè¯·æ±‚api/todoitemsè·å–å±•ç¤ºåˆ—è¡¨
```js
fetch(uri)
  .then(response => response.json())
  .then(data => _displayItems(data))
  .catch(error => console.error('Unable to get items.', error));
```
- Web APIè¿”å›æˆåŠŸçŠ¶æ€çš„ä»£ç æ—¶ï¼Œè°ƒç”¨_displayItemså‡½æ•°
- å‡½æ•°å°†å‚æ•°æ·»åŠ åˆ°è¡¨ä¸­
- å¦‚æœè¯·æ±‚å¤±è´¥ï¼Œä¼šå°†é”™è¯¯è®°å½•è®°å½•åˆ°æµè§ˆå™¨æ§åˆ¶å°

## æ·»åŠ å¾…åŠäº‹é¡¹
```js
function addItem() {
  const addNameTextbox = document.getElementById('add-name');

  const item = {
    isComplete: false,
    name: addNameTextbox.value.trim()
  };

  fetch(uri, {
    method: 'POST',
    headers: {
      'Accept': 'application/json',
      'Content-Type': 'application/json'
    },
    body: JSON.stringify(item)
  })
    .then(response => response.json())
    .then(() => {
      getItems();
      addNameTextbox.value = '';
    })
    .catch(error => console.error('Unable to add item.', error));
}
```

-   å£°æ˜ `item` å˜é‡æ¥æ„é€ å¾…åŠäº‹é¡¹çš„å¯¹è±¡æ–‡å­—è¡¨ç¤ºå½¢å¼ã€‚
-   ä½¿ç”¨ä»¥ä¸‹é€‰é¡¹æ¥é…ç½®æå–è¯·æ±‚ï¼š
    -   `method`â€”æŒ‡å®š POST HTTP æ“ä½œè°“è¯ã€‚
    -   `body`â€”æŒ‡å®šè¯·æ±‚æ­£æ–‡çš„ JSON è¡¨ç¤ºå½¢å¼ã€‚ é€šè¿‡å°†å­˜å‚¨åœ¨ `item` ä¸­çš„å¯¹è±¡æ–‡å­—ä¼ é€’åˆ° [JSON.stringify](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/JSON/stringify) å‡½æ•°æ¥ç”Ÿæˆ JSONã€‚
    -   `headers`â€”æŒ‡å®š `Accept` å’Œ `Content-Type` HTTP è¯·æ±‚æ ‡å¤´ã€‚ å°†ä¸¤ä¸ªæ ‡å¤´éƒ½è®¾ç½®ä¸º `application/json`ï¼Œä»¥ä¾¿åˆ†åˆ«æŒ‡å®šæ¥æ”¶å’Œå‘é€çš„åª’ä½“ç±»å‹ã€‚
-   å°† HTTP POST è¯·æ±‚å‘é€åˆ° api/todoitems è·¯ç”±ã€‚


## æ›´æ–°å¾…åŠäº‹é¡¹
```js
fetch(`${uri}/${itemId}`, {
  method: 'PUT',
  headers: {
    'Accept': 'application/json',
    'Content-Type': 'application/json'
  },
  body: JSON.stringify(item)
})
.then(() => getItems())
.catch(error => console.error('Unable to update item.', error));
```

æ›´æ–°å¾…åŠäº‹é¡¹ç±»ä¼¼äºæ·»åŠ å¾…åŠäº‹é¡¹ï¼›ä½†æ˜¯ï¼ŒäºŒè€…å­˜åœ¨ä¸¤ä¸ªé‡å¤§å·®å¼‚ï¼š

-   è·¯ç”±çš„åç¼€ä¸ºå¾…æ›´æ–°é¡¹çš„å”¯ä¸€æ ‡è¯†ç¬¦ã€‚ ä¾‹å¦‚ api/todoitems/1ã€‚
-   æ­£å¦‚ `method` é€‰é¡¹æ‰€ç¤ºï¼ŒHTTP æ“ä½œè°“è¯æ˜¯ PUTã€‚

## åˆ é™¤å¾…åŠäº‹é¡¹
```
fetch(`${uri}/${id}`, {
  method: 'DELETE'
})
.then(() => getItems())
.catch(error => console.error('Unable to delete item.', error));
```

è‹¥è¦åˆ é™¤å¾…åŠäº‹é¡¹ï¼Œè¯·å°†è¯·æ±‚çš„ `method` é€‰é¡¹è®¾ç½®ä¸º `DELETE` å¹¶æŒ‡å®šè¯¥é¡¹åœ¨ URL ä¸­çš„å”¯ä¸€æ ‡è¯†ç¬¦ã€‚


# é€‚ç”¨äºç§»åŠ¨è®¾å¤‡çš„åç«¯
å¾…å®š
# å‘å¸ƒåˆ°Azure APIç®¡ç†
å¾…å®š