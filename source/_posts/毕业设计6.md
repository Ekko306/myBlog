---
title: æ¯•ä¸šè®¾è®¡6
categories:
  - ä¸ªäººæå‡
  - æ¯•ä¸šè®¾è®¡
thumbnailImage: 'http://cdn.ekko306.top/cover/Red%20Pill%20Blues%20%28Deluxe%29.jpg'
date: 2021-12-04 13:02:03
tags:
coverImage:
coverCaption:
gallery:
---

æœ€ä¸»è¦çš„SignalR
<!-- more -->
<!-- toc -->
# ä½¿ç”¨JavaScriptçš„SignalR
ğŸ¦„ï¼š[githubåœ°å€:SignalRChat](https://github.com/Ekko306/SignalR_Practice/tree/main/SignalRChat)
ğŸ½ï¼š[æ–‡æ¡£åœ°å€](https://docs.microsoft.com/zh-cn/aspnet/core/tutorials/signalr?view=aspnetcore-3.1&tabs=visual-studio-mac)
## å…ˆå†³æ¡ä»¶
- Visual Studio for Mac
- .NET Core 3.1 SDK
## åˆ›å»ºWebåº”ç”¨é¡¹ç›®
åˆ›å»ºåå«SignalRChat
## æ·»åŠ SignalRå®¢æˆ·ç«¯åº“
å…ˆå®‰è£…å·¥å…·LibMan
`dotnet tool install -g Microsoft.Web.LibraryManager.Cli`

ç„¶åè°ƒç”¨å·¥å…·LibMan
`libman install @microsoft/signalr@latest -p unpkg -d wwwroot/js/signalr --files dist/browser/signalr.js --files dist/browser/signalr.min.js`

ä½œç”¨ï¼š
- ä½¿ç”¨unpkgæä¾›ç¨‹åº
- å°†æ–‡ä»¶å¤åˆ¶åˆ°wwwroot/jssignalrç›®æ ‡
- ä»…å¤åˆ¶æŒ‡å®šçš„æ–‡ä»¶



## åˆ›å»ºSIgnalRä¸­å¿ƒ
ä¸­å¿ƒæ˜¯ä¸€ä¸ªç±»ï¼Œç”¨ä½œå¤„ç†å®¢æˆ·ç«¯-æœåŠ¡å™¨é€šä¿¡çš„é«˜çº§ç®¡é“
åˆ›å»ºHubs/ChatHub.cs
```cs
using Microsoft.AspNetCore.SignalR;
using System.Threading.Tasks;

namespace SignalRChat.Hubs
{
    public class ChatHub : Hub
    {
        public async Task SendMessage(string user, string message)
        {
            await Clients.All.SendAsync("ReceiveMessage", user, message);
        }
    }
}
```

ChatHubç±»ç»§æ‰¿è‡ªSignalRçš„Hubç±»ï¼ŒHubç±»ç®¡ç†è¿æ¥ã€ç»„åˆæ¶ˆæ¯

å¯ä»¥é€šè¿‡å®¢æˆ·ç«¯è°ƒç”¨SendMessageæ–¹æ³•ï¼Œå‘æ‰€æœ‰å®¢æˆ·ç«¯å‘é€æ¶ˆæ¯ï¼Œåé¢è¿˜ä¼šæ•™jsçš„å®¢æˆ·ç«¯ä»£ç 

## é…ç½®SignalR
åœ¨Startup.csé…ç½®SignalRæœåŠ¡å™¨é…ç½®
```
public void ConfigureServices(IServiceCollection services)
        {
            services.AddRazorPages();
            services.AddSignalR();
        }
```

è¿™äº›æ›´æ”¹å°†SIgnalRæ·»åŠ åˆ°ASP.NET Coreä¾èµ–å…³ç³»æ³¨å…¥å’Œè·¯ç”±ç³»ç»Ÿ
## æ·»åŠ SignalRå®¢æˆ·ç«¯ä»£ç 
ç”¨ä»¥ä¸‹ä»£ç æ›¿æ¢Pages/Index.cshtml
ç„¶åå¢åŠ chat.js

ç»†èŠ‚çœ‹ä»£ç 

ä¸»è¦æ˜¯ç›‘å¬id="sendButton"çš„æŒ‰é’®ï¼Œç‚¹å‡»äº‹ä»¶åè§¦å‘SendMessageæ–¹æ³•
## è¿è¡Œä»£ç 
æˆåŠŸè¿è¡Œ

æœ‰æœ€åŸºæœ¬çš„ç”¨æ³•


# ä½¿ç”¨TypeScriptçš„SignalR
ğŸ¦„ï¼š[githubåœ°å€:SignalRWebPack](https://github.com/Ekko306/SignalR_Practice/tree/main/SignalRWebPack)
ğŸ½ï¼š[æ–‡æ¡£åœ°å€](https://docs.microsoft.com/zh-cn/aspnet/core/tutorials/signalr-typescript-webpack?view=aspnetcore-3.1&tabs=visual-studio-code)

è¿™ä¸ªè¦ç”¨åˆ°tsï¼Œæœ‰äº›ä¸ä¸€æ ·ï¼Œè¦ç”¨åˆ°npmï¼Œæ›´ç±»ä¼¼reactï¼Œç„¶è¿˜æ˜¯æœ‰cshtmlå’Œcsä»£ç ï¼Œæ˜¯ASP.NETæ¡†æ¶

è¯´æ˜¯tsï¼Œè¿˜æ˜¯ç”¨tsç¼–è¯‘å‡ºé™æ€çš„åˆ°wwwrootï¼Œç„¶åç”¨`dotnet run`å¯åŠ¨ï¼Œè¿˜æ›´éº»çƒ¦äº†ä¸€äº›

## å…ˆå†³æ¡ä»¶
- visual studio code
- .NET Core SDK 3.0
- npmå’Œnodejsï¼ˆtsæ£€æµ‹éœ€è¦ï¼‰

## åˆ›å»ºASP.NET Core Webåº”ç”¨
ç”¨dotnetå‘½ä»¤åˆ›å»ºé¡¹ç›®

`dotnet new web -o SignalRWebPack`


ç„¶åæ·»åŠ tsçš„åŒ…ï¼Œå¯åŠ¨tsç¼–è¯‘
`dotnet add package Microsoft.TypeScript.MSBuild`

## é…ç½®Webpackå’ŒTypeScript
é…ç½®å¤ªåŸå§‹äº†
1. `npm init -y`
2. æ·»åŠ package.jsonï¼Œæ·»åŠ â€œprivateâ€: trueé˜²æ­¢å®‰è£…åŒ…å‡ºç°è­¦å‘Š
3. `npm i -D -E clean-webpack-plugin@3.0.0 css-loader@3.4.2 html-webpack-plugin@3.2.0 mini-css-extract-plugin@0.9.0 ts-loader@6.2.1 typescript@3.7.5 webpack@4.41.5 webpack-cli@3.3.10`
4. æ›´æ”¹scriptså‘½ä»¤ï¼š
```
"scripts": {
  "build": "webpack --mode=development --watch",
  "release": "webpack --mode=production",
  "publish": "npm run release && dotnet publish -c Release"
},
```
buildæ˜¯å¼€å‘ç¯å¢ƒå®æ—¶æŸ¥çœ‹ï¼Œreleaseæ˜¯å¼€å‘ç¯å¢ƒç”Ÿæˆï¼Œpublishå’Œdotnetä¸€èµ·å‘å¸ƒ
5. åˆ›å»ºwebpack.config.js

åŒ…å«åŸºç¡€çš„tså’Œæ’ä»¶

```js
const path = require("path");
const HtmlWebpackPlugin = require("html-webpack-plugin");
const { CleanWebpackPlugin } = require("clean-webpack-plugin");
const MiniCssExtractPlugin = require("mini-css-extract-plugin");
module.exports = {
    entry: "./src/index.ts",
    output: {
        path: path.resolve(__dirname, "wwwroot"),
        filename: "[name].[chunkhash].js",
        publicPath: "/"
    },
    resolve: {
        extensions: [".js", ".ts"]
    },
    module: {
        rules: [
            {
                test: /\.ts$/,
                use: "ts-loader"
            },
            {
                test: /\.css$/,
                use: [MiniCssExtractPlugin.loader, "css-loader"]
            }
        ]
    },
    plugins: [
        new CleanWebpackPlugin(),
        new HtmlWebpackPlugin({
            template: "./src/index.html"
        }),
        new MiniCssExtractPlugin({
            filename: "css/[name].[chunkhash].css"
        })
    ]
};
```

é…ç½®æ–‡ä»¶
- outputæ›¿ä»£é»˜è®¤dist æ”¹æˆwwwroot
- resolve.extensionsåŒ…å«.js ä»¥ä¾¿å¯¼å…¥SignalRå®¢æˆ·ç«¯çš„js


ç„¶åå†å¢åŠ src/index.html
src/css/amin.css
src/tsconfig.json
src/index.ts tsé‡Œå…ˆå†™å¥½æ¡†æ¶ï¼Œclickå’Œkeyupæ—¶é—´


## é…ç½®åº”ç”¨

### 1 Startup.Configure
Startup.Configureæ·»åŠ å¯¹UseDefaultFileså’ŒUseStaticFilesçš„è°ƒç”¨

`app.UseDefaultFiles(); app.UseStaticFiles();`

å…è®¸æŸ¥æ‰¾å’Œå¤„ç†index.htmlï¼Œç”¨é™æ€çš„è¿™ä¸ªæ–‡ä»¶


### 2 Startup.ConfigureServices
åœ¨Startup.ConfigureServicesè°ƒç”¨AddSignalR
`services.AddSignalR();`

æ·»åŠ å¼•ç”¨

`using SignalRWebPack.Hubs;`


### 3 æ·»åŠ Hubs/ChatHub.csã€
```
using Microsoft.AspNetCore.SignalR;
using System.Threading.Tasks;

namespace SignalRWebPack.Hubs
{
    public class ChatHub : Hub
    {
        public async Task NewMessage(long username, string message)
        {
            await Clients.All.SendAsync("messageReceived", username, message);
        }
    }
}
```

æ³¨æ„NEwMessageæ”¾

æœåŠ¡å™¨åœ¨æ”¶åˆ°æ¶ˆæ¯åï¼Œå‰é¢çš„ä»£ç ä¼šå°†è¿™äº›æ¶ˆæ¯æ’­å‘åˆ°æ‰€æœ‰è¿æ¥çš„yoghurtï¼Œæ²¡æœ‰å¿…è¦ä½¿ç”¨æ³›å‹onæ–¹æ³•æ¥æ”¶æ‰€æœ‰çš„æ¶ˆæ¯ï¼Œä½¿ç”¨æ¶ˆæ¯åç§°å‘½åçš„æ–¹æ³•å°±å¯ä»¥äº†

å®¢æˆ·ç«¯å‘é€newMessageï¼ŒClients.Allè°ƒç”¨SendAsyncè¿›è¡Œè°ƒç”¨

## å¯ç”¨å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨é€šä¿¡

å®‰è£…ä»¥ä¸‹å‘½ä»¤ï¼š
`npm i @microsoft/signalr @types/node`
-   [SignalR TypeScript å®¢æˆ·ç«¯](https://www.npmjs.com/package/@microsoft/signalr)ï¼Œå®ƒå…è®¸å®¢æˆ·ç«¯å‘æœåŠ¡å™¨å‘é€æ¶ˆæ¯ã€‚
-   ç”¨äº node.js çš„ TypeScript ç±»å‹å®šä¹‰ï¼Œæ”¯æŒ Node.js ç±»å‹çš„ç¼–è¯‘æ—¶æ£€æŸ¥ã€‚


å®Œå–„src/index.tsæ–‡ä»¶
```
import "./css/main.css";
import * as signalR from "@microsoft/signalr";

const divMessages: HTMLDivElement = document.querySelector("#divMessages");
const tbMessage: HTMLInputElement = document.querySelector("#tbMessage");
const btnSend: HTMLButtonElement = document.querySelector("#btnSend");
const username = new Date().getTime();

const connection = new signalR.HubConnectionBuilder()
    .withUrl("/hub")
    .build();

connection.on("messageReceived", (username: string, message: string) => {
    let messages = document.createElement("div");

    messages.innerHTML =
        `<div class="message-author">${username}</div><div>${message}</div>`;

    divMessages.appendChild(messages);
    divMessages.scrollTop = divMessages.scrollHeight;
});

connection.start().catch(err => document.write(err));

tbMessage.addEventListener("keyup", (e: KeyboardEvent) => {
    if (e.key === "Enter") {
        send();
    }
});

btnSend.addEventListener("click", send);

function send() {
    connection.send("newMessage", username, tbMessage.value)
        .then(() => tbMessage.value = "");
}
```

é€»è¾‘å°±æ˜¯è°ƒç”¨newMessageæ–¹æ³•

## æµ‹è¯•åº”ç”¨
1. npm run release
2. dotnet run
3. æ‰“å¼€http://localhost:5001 




# ä½¿ç”¨Blazorçš„SignalR
ğŸ¦„ï¼š[githubåœ°å€:BlazorServerSignalRApp](https://github.com/Ekko306/SignalR_Practice/tree/main/BlazorServerSignalRApp)
ğŸ½ï¼š[æ–‡æ¡£åœ°å€](https://docs.microsoft.com/zh-cn/aspnet/core/tutorials/signalr-blazor?view=aspnetcore-3.1&tabs=visual-studio-mac&pivots=server)

## å…ˆå†³æ¡ä»¶
- Visual Studio for Mac
- .NET COre 3.1 SDK

## åˆ›å»ºBlazor Serveråº”ç”¨
é€‰æ‹©Blazor Server
åˆ›å»ºåå«BlazorServerSignalRApp

## æ·»åŠ SignalRå®¢æˆ·ç«¯åº“
åœ¨è§£å†³æ–¹æ¡ˆèµ„æºç®¡ç†å™¨ä¸­æ·»åŠ `Microsoft.AspNetCore.SignalR.Client`

## æ·»åŠ System.Text.Encodings.WebåŒ…
åªé€‚ç”¨äº3.x ï¼ŒåŠ ä¸Šè¿™ä¸ªé¢å¤–çš„åŒ…ï¼Œåˆ«çš„ç‰ˆæœ¬å¯èƒ½ä¸éœ€è¦

## æ·»åŠ SignalRé›†çº¿å™¨
æ·»åŠ Hub/ChatHubç±»
```
using System.Threading.Tasks;
using Microsoft.AspNetCore.SignalR;

namespace BlazorServerSignalRApp.Server.Hubs
{
    public class ChatHub : Hub
    {
        public async Task SendMessage(string user, string message)
        {
            await Clients.All.SendAsync("ReceiveMessage", user, message);
        }
    }
}
```

## ä¸ºSignalRä¸­å¿ƒæ·»åŠ æœåŠ¡å’Œç»ˆç»“ç‚¹
Starup.cs
### ç¬¬ä¸€æ­¥ï¼šæ·»åŠ å‘½åç©ºé—´
`using Microsoft.AspNetCore.ResponseCompression;
using BlazorServerSignalRApp.Server.Hubs;`


### ç¬¬äºŒæ­¥ï¼š
æ·»åŠ Startup.ConfigureServices

```
services.AddResponseCompression(opts =>
    {
        opts.MimeTypes = ResponseCompressionDefaults.MimeTypes.Concat(
            new[] { "application/octet-stream" });
    });
```

è¿™å«å°†å“åº”ä¸‹æ‰€ä¸­é—´ä»¶æœåŠ¡æ·»åŠ 

### ç¬¬ä¸‰æ­¥ï¼š
æ·»åŠ Startup.Configure

- ä½¿ç”¨ä¸Šé¢é…ç½®çš„å“åº”å‹ç¼©ä¸­é—´ä»¶
- åœ¨æ˜ å°„Blazorä¸­å¿ƒçš„ç»ˆç»“ç‚¹å’Œå®¢æˆ·ç«¯å›é€€ä¹‹é—´ï¼Œä¸ºä¸­å¿ƒæ·»åŠ ä¸€ä¸ªç»ˆç»“ç‚¹

```
public void Configure(IApplicationBuilder app, IWebHostEnvironment env)
{
    app.UseResponseCompression();      // 
    if (env.IsDevelopment())
    {
        app.UseDeveloperExceptionPage();
    }
    else
    {
        app.UseExceptionHandler("/Error");
        app.UseHsts();
    }

    app.UseHttpsRedirection();
    app.UseStaticFiles();

    app.UseRouting();

    app.UseEndpoints(endpoints =>
    {
        endpoints.MapBlazorHub();
        endpoints.MapHub<ChatHub>("/chathub");  // 
        endpoints.MapFallbackToPage("/_Host");
    });
}
```

## æ·»åŠ ç”¨äºèŠå¤©çš„Razorç»„ä»¶ä»£ç 
ä¿®æ”¹Pages/Index.razoræ–‡ä»¶
ä¹‹å‰å­¦çš„ç±»ä¼¼jsxå†™æ³•çš„


åŒæ ·æ˜¯è°ƒç”¨SendMessageæ–¹æ³•

## è¿è¡Œåº”ç”¨
æ­£å¸¸å¯ä»¥å¯åŠ¨